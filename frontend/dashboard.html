<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="img/coupon.png">
  <link rel="icon" type="image/png" href="img/coupon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    COUPONS APP
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="css/fonts-google-roboto.css" />
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <!-- CSS Files -->
  
  <link href="css/material-dashboard.css?v=2.1.1" rel="stylesheet" />
</head>

<body class="">
  <!--
    user roles:
      0 - those cool guys that made this app, aka admin
      1 - manager
      2 - staff
  -->

    <div class="modal fade" id="alert_modal" role="dialog">
        <div class="modal-dialog">
          <!-- Modal content-->
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title"><b>Incorrect password!</b></h4>
            </div>
            <div class="modal-body">
              <p>Please insert password again to clear event.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal" id="close_modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="clear_alert_modal" role="dialog">
        <div class="modal-dialog">
          <!-- Modal content-->
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title"><b>Enter password to clear event</b></h4>
            </div>
            <div class="modal-body">
              <center>
                <form> 
                    <input type = 'password' id='login_modal_password' placeholder = '********'> 
                </form> 
              </center>
            </div>
            <div class="modal-footer" id="clear_alert_modal_confirm_btn_div">
              <!--button type="button" class='templatemo-blue-button width-100' id='confirm_clear_alert' data-dismiss="modal">Confirm</button-->
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="coupon_created_modal" role="dialog">
          <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title" id="modal-title-area"></h4>
              </div>
              <div class="modal-body">
                <center>
					<p id="modal-text-area"></p>
                </center>
              </div>
              <div class="modal-footer">
                <button type="button" class='templatemo-blue-button width-100' id='confirm_action' data-dismiss="modal">Ok</button>
              </div>
            </div>
          </div>
        </div>

  <div class="wrapper ">
    <div class="sidebar" data-color="azure" data-background-color="white" data-image="img/sidebar-3.jpg">

      <!--  
        Tip 1: You can change the color of the sidebar using: data-color="purple | azure | green | orange | danger"

        Tip 2: you can also add an image using data-image tag 
      -->

      <div class="logo">
        <div class="row">
            <div class="column" style="width: 30%; margin-left: 13%">
              <img style="width:40px" src="img/coupon.png" />
            </div>
            <div class="column" style="width:70%; margin-left: -160%">
              <a href="#" class="simple-text logo-normal">
                  C-App
              </a>
            </div>
          </div>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav">
          <li class="nav-item active  ">
            <a class="nav-link" href="./dashboard.html">
              <i class="material-icons">dashboard</i>
              <p>Your Dashboard</p>
            </a>
          </li>
          <li class="nav-item ">
            <a class="nav-link" href="./history.html">
              <i class="material-icons">history</i>
              <p>Your History</p>
            </a>
          </li>
          <li class="nav-item "  id='create_user_tab'>
            <a class="nav-link" href="./user.html">
              <i class="material-icons">person</i>
              <p>Your Account</p>
            </a>
          </li>
		<li class="nav-item" id='admin_tab'>
			<a class="nav-link" href="./admin.html">
				<i class="material-icons">settings</i>
				<p>Admin</p>
			</a>
		</li>
        </ul>
      </div>
    </div>
	<div class="main-panel">
		<!-- Navbar -->
		<nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
			<div class="container-fluid">
				<div class="navbar-wrapper">
					<a class="navbar-brand" href="">Dashboard</a>
				</div>
				<button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
					<span class="sr-only">Toggle navigation</span>
					<span class="navbar-toggler-icon icon-bar"></span>
					<span class="navbar-toggler-icon icon-bar"></span>
					<span class="navbar-toggler-icon icon-bar"></span>
				</button>
				<div class="collapse navbar-collapse justify-content-end">
					<ul class="navbar-nav">
						<li class="nav-item dropdown" id="alerts-button">
							<a class="nav-link" href="" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<i class="material-icons">notifications</i>
								<span class="notification" id="number_of_alerts"></span>
							</a>
							<div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink" id="alerts_enumeration_div">
								<a class="dropdown-item" id="alerts-a" href="history.html">No active alerts!</a>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link" href="" id="navbarDropdownProfile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<i class="material-icons">person</i>
								<p class="d-lg-none d-md-block">
									Account
								</p>
							</a>
							<div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownProfile">
								<a class="dropdown-item" href="user.html" id="username_display"></a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#" id="logout">Log out</a>
							</div>
						</li>
					</ul>
				</div>
			</div>
		</nav>
		<!-- End Navbar -->
		<div class="content">

			<div class="col-md-4">
				<!-- <button class="btn btn-primary btn-block" onclick="md.showAlertNotification('top','center', '')">Show Notification</button>  -->
			</div>
			<!--InteresContent-->
			<!--Progress bar-->

			<div class="card">
				<div class="card-header card-header-info">
					<h4 class="card-title">Receipt code</h4>
					<p class="card-category">Enter the code for your receipt here.</p>
				</div>
				<div class="card-body">
					<form>
						<div class="row">
							<div class="col-md-6">
								<div class="form-group">
									<label class="bmd-label-floating">Code</label>
									<input class="form-control" id="receipt-code">
								</div>
							</div>
							<div class="form-group col-md-2">
							</div>
							<div class="form-group col-md-2">
									<button class="btn btn-info pull-right" id="update-balance">Add</button>
							</div>
						</div>
						<div class="clearfix"></div>
						<div class="progressB" style="width: 100%;">
							<div class="progress__fill"></div>
							<span class="progress__text" style="width:100%" align="center"></span>
						</div>
					</form>
				</div>
			</div>


		<div class="container-fluid" id="main-container-dashboard">
			<div class="row">
              
              <div class="card">
                <div class="card-header card-header-warning">
                  <h4 class="card-title">History</h4>
                  <p class="card-category">Coupons history</p>
                </div>
                <div class="card-body table-responsive">
                  <table class="table table-hover" id="coupons-table">
                    <thead class="text-warning">
                      <th>Coupon Code</th>
                      <th>Discount</th>
					  <th>Time when used</th>
                      <th>Time when expire</th>
                      <th>Shop</th>
                    </thead>
                    <tbody id="access_event_table_body">

                    </tbody>
                  </table>
                </div>
          </div>
        </div>


			</div>

			<div class="row">
				<div class="col-lg-11 col-md-12" style="margin-left: auto; margin-right: auto;">

					<div class="col-lg-12 col-md-12">
						<div class="card">
						</div>
					</div>
				</div>
			</div>
		</div>
		<footer class="footer">
			<div class="container-fluid">
				<div class="copyright float-right">
					<!-- &copy;
				<script>
				  document.write(new Date().getFullYear())
				</script>, <a href="http://hbfsrobotics.com" target="_blank">HBFS Robotics</a> for
				  <a href="http://unionplaza.ro" target="_blank">Union Plaza Hotel</a> -->
				</div>
			</div>
		</footer>
	</div>
  </div>
  <!--   Core JS Files   -->
  <script src="js/core/jquery.min.js"></script>
  <script src="js/core/popper.min.js"></script>
  <script src="js/core/bootstrap-material-design.min.js"></script>
  <script src="js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!-- Plugin for the momentJs  -->
  <script src="js/plugins/moment.min.js"></script>
  <!--  Plugin for Sweet Alert -->
  <script src="js/plugins/sweetalert2.js"></script>
  <!-- Forms Validations Plugin -->
  <script src="js/plugins/jquery.validate.min.js"></script>
  <!-- Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
  <script src="js/plugins/jquery.bootstrap-wizard.js"></script>
  <!-- Include a polyfill for ES6 Promises (optional) for IE11, UC Browser and Android browser support SweetAlert -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.js"></script> -->
  <!-- Library for adding dinamically elements -->
  <script src="js/plugins/arrive.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="js/plugins/bootstrap-notify.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

  <script src='js/graph_interface.js'></script>
  <script src='js/nfc_interface.js'></script>


  <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="js/material-dashboard.js?v=2.1.1" type="text/javascript"></script>
  <!----<script src="js/dashboard.js?v=2.1.1" type="text/javascript"></script> -->

  <script>
    $(document).ready(function() {

      /*if( BMSGraphClient.account.getUserData().role == 2) {
        $('#create_user_tab').hide();
      }
      else {
        $('#create_user_tab').show();
      }*/

      $(document).ready(function() {
        $sidebar = $('.sidebar');
        $sidebar_img_container = $sidebar.find('.sidebar-background');
        $full_page = $('.full-page');
        $sidebar_responsive = $('body > .navbar-collapse');

        window_width = $(window).width();

        fixed_plugin_open = $('.sidebar .sidebar-wrapper .nav li.active a p').html();

        if (window_width > 767 && fixed_plugin_open == 'Dashboard') {
          if ($('.fixed-plugin .dropdown').hasClass('show-dropdown')) {
            $('.fixed-plugin .dropdown').addClass('open');
          }

        }

      });
    });
  </script>
  <script>
    $(document).ready(function()  
    { 
     $.ajax({
            url: "http://localhost:8123/api/v1/customer-controller/customer-balance",
            type: "GET",
			beforeSend: function (xhr) {
				xhr.setRequestHeader ("Authorization", "Basic " + btoa( "api-user:admin" ));
				},
            data:{'customerId':sessionStorage.getItem("customerId")},
            success: function(result) {
					$(".progress__fill").css("width",(result*10)+"%");
					$(".progress__text").html(result +" points / 10 points");
			}
         });
		getCustomerCoupons();
	});
	
	function getCustomerCoupons(){
		$.ajax({
            url: "http://localhost:8123/api/v1/customer-controller/customer-coupons",
            type: "GET",
			beforeSend: function (xhr) {
				xhr.setRequestHeader ("Authorization", "Basic " + btoa( "api-user:admin" ));
				},
            data:{'customerId':sessionStorage.getItem("customerId")},
            success: function(result) {
				var tbl=$("#access_event_table_body").empty();
				for(var i=0;i<result.length;i++)
				{
					var tr="<tr>";
					var td1="<td>"+result[i]["code"]+"</td>";
					var td2="<td>"+result[i]["value"]+" RON</td>";
					var td3="<td>"+(result[i]["usedDate"] ? result[i]["usedDate"].split("T")[0] : "not used")+"</td>";
					var td4="<td>"+result[i]["expirationDate"].split("T")[0]+"</td>";
					var td5="<td>"+(result[i]["shopName"]? result[i]["shopName"] : "not used")+"</td></tr>";

				   tbl.append(tr+td1+td2+td3+td4+td5); 
			   }
			},
			error: function(result) {
				
			}
         })}
	
	$("#update-balance").click(function(e){
		e.preventDefault();
		$.LoadingOverlay("show");
		$.ajax({
            url: "http://localhost:8123/api/v1/customer-controller/update-balance",
            type: "POST",
			beforeSend: function (xhr) {
				xhr.setRequestHeader ("Authorization", "Basic " + btoa( "api-user:admin" ));
				},
            data:{'customerId':sessionStorage.getItem("customerId"),'encodedFiscal':$("#receipt-code").val()},
            success: function(result) {
					$.LoadingOverlay("hide");
					$(".progress__fill").css("width",(result.currentBalance*10)+"%");
					$(".progress__text").html(result.currentBalance +" points / 10 points");
					var text;
					if(result.couponsCreated >0){
					   text = "You have recieved "+result.couponsCreated+" coupons, check your email address.";
						getCustomerCoupons();
					}else{
					   text = "Your receipt has been successfully validated! "+result.value+" points were added to your account.</br>You need to collect "+ (10-result.currentBalance)+" more points to recieve a coupon!";
					}
					$("#modal-title-area").html("<b>Congratulations, "+sessionStorage.getItem("firstName")+"!</b>");
					$("#modal-text-area").html(text);
					$('#coupon_created_modal').modal();
					$("#number_of_alerts").text(result.activeCoupons);
			},
			error: function(result){
				$.LoadingOverlay("hide");
				$("#modal-title-area").html("<b>Hmm, something went wrong!</b>");
				$("#modal-text-area").html("Your receipt is invalid, please try again carefully.");	
				$('#coupon_created_modal').modal();	
			}
         });
	});
	

	
  </script>
</body>

</html>